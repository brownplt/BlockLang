<html>
<head>
    <script type="text/javascript" src="closure-library/closure/goog/base.js"></script>
    <script type="text/javascript" src="ray/ray-deps.js"></script>
    <title>UI Demo</title>
    <link rel="stylesheet" type="text/css" href="ink-2.2.0/css/ink-custom.css">
    <link rel="stylesheet" type="text/css" href="ray/ui/css/ui.css">
    <script type="text/javascript">
        /** Ray Imports */
        goog.require('Ray.Main');
        goog.require('Ray.Shared');
        goog.require('Ray.UI');
        /** Closure Library Imports */
        goog.require('goog.dom');
        goog.require('goog.events');
        goog.require('goog.events.EventType');
        goog.require('goog.ui.Button');
        goog.require('goog.ui.FlatButtonRenderer');
        goog.require('goog.ui.LabelInput');
        goog.require('goog.ui.Tab');
        goog.require('goog.ui.TabBar');
        goog.require('goog.ui.Textarea');
        goog.require('goog.ui.TextareaRenderer');
        goog.require('goog.ui.SplitPane');
        goog.require('goog.ui.SplitPane.Orientation');
    </script>
</head>
<body>
<div class="ink-grid">
<div id="header" class="column-group">
    <div class="large-50">

        <div id="create_function_button"
             class="goog-flat-button goog-inline-block"
             title="Define a new function to use in your program">
            Create a new function
        </div>


        <div id="evaluate_expression_button"
             class="evaluate-button goog-inline-block"
             title="Evaluate the program in the main workspace">
            Evaluate expression in Main Workspace
        </div>
    </div>
    <div class="large-50 content-right">
        <div id="evaluation_results"></div>
    </div>
</div>
<div class="body">
    <div id="workspace_tabs" class="goog-tab-bar goog-tab-bar-top">
        <div id="tab_blockly_main" class="goog-tab goog-tab-selected">Main Workspace</div>
    </div>
    <div class="goog-tab-bar-clear"></div>
    <div id="workspace_content" class="goog-tab-content">
        <div class="container">
            <iframe id="blockly_main" src="Javascript:''"></iframe>
        </div>
    </div>
</div>
</div>
<script>
    var r = Ray.Main.createRay();
    var blocks = Ray.Main.createRayBlocks(r);
    Ray.Shared.setRayInstance(r);
    Ray.Shared.setBlocks(blocks);
    Ray.Shared.attachToBlockly(Blockly);
    var dialog = Ray.UI.FunDef.makeDialog(goog.dom.getDomHelper(document.body));
    dialog.createDom();
    dialog.testPopulate_();

    var workspaceContent = goog.dom.getElement('workspace_content');
    var tabBar = new goog.ui.TabBar();
    tabBar.decorate(goog.dom.getElement('workspace_tabs'));
    tabBar.getSelectedTab().workspaceId_ = 'blockly_main';

    Ray.Main.resizeWorkspaceContent();
    goog.events.listen(window, goog.events.EventType.RESIZE, Ray.Main.resizeWorkspaceContent);

    var createFunctionButton = new goog.ui.Button(undefined, goog.ui.FlatButtonRenderer.getInstance());
    createFunctionButton.decorate(goog.dom.getElement('create_function_button'));
    goog.events.listen(createFunctionButton, goog.ui.Component.EventType.ACTION, function(e) {
        dialog.asCreate();
        dialog.setVisible(true);

    });

    var evaluateButton = new goog.ui.Button(undefined, Ray.UI.Util.EvaluateButtonRenderer);
    evaluateButton.decorate(goog.dom.getElement('evaluate_expression_button'));

    var evaluationResults = goog.dom.getElement('evaluation_results');
    goog.style.setInlineBlock(evaluationResults);
    goog.dom.setTextContent(evaluationResults, 'Results of last evaluation...');

    goog.events.listen(evaluateButton, goog.ui.Component.EventType.ACTION, function(e) {
        var result = Ray.Main.go(evaluateButton);
        goog.dom.setTextContent(evaluationResults, result);
    });

    dialog.onCreate(function(e) {
        var funSpec = dialog.getFunSpec();
        funSpec.funId = Ray.UI.getFunId();
        var funBlocks = Ray.Main.makeFunAppAndArgBlocks(r, funSpec);
        var funArgBlocks = funBlocks.args;
        var funAppBlock = funBlocks.app;
        Ray.Shared.addToSavedBlocks(funAppBlock);

        var funDefWorkspace = Ray.UI.addFunDefWorkspaceDom(funSpec.funId, workspaceContent);
        var funDefInfo = {
            funId: funSpec.funId,
            funArgBlockProtos: funArgBlocks,
            funAppBlockProto: funAppBlock,
            funName: funSpec.name,
            funSpec: funSpec
        };
        Ray.Main.loadFunDefBlockly(funDefWorkspace,
                                   funDefInfo, tabBar, workspaceContent);

        // We will create the tab and load it from the iframe
    });

    goog.events.listen(tabBar, goog.ui.Component.EventType.SELECT, function(e) {
        Ray.UI.selectTab(e.target, workspaceContent);
    });
    goog.events.listen(tabBar, goog.ui.Component.EventType.UNSELECT, function(e) {
        Ray.UI.deselectTab(e.target);
    });

    //Ray.Main.initializeMainBlocklyDom();
    Ray.Main.initializeFunDefBlocklyDom();
    Ray.Main.loadMainBlockly(Ray.Main.mainBlockly());

    goog.events.listen(window, goog.events.EventType.BEFOREUNLOAD, function(e) {
        return 'If you leave the page, any unsaved programs will be lost!';
    });
</script>
</body>

</html>