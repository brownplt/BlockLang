<html>
<head>
    <script type="text/javascript" src="../../closure-library-read-only/closure/goog/base.js"></script>
    <script type="text/javascript" src="../ray-deps.js"></script>
    <title>UI Demo</title>
    <link rel="stylesheet" type="text/css" href="css/ui.css">
    <script type="text/javascript">
        /** Ray Imports */
        goog.require('Ray.Main');
        goog.require('Ray.Shared');
        goog.require('Ray.UI');
        /** Closure Library Imports */
        goog.require('goog.dom');
        goog.require('goog.events');
        goog.require('goog.events.EventType');
        goog.require('goog.ui.Button');
        goog.require('goog.ui.FlatButtonRenderer');
        goog.require('goog.ui.LabelInput');
        goog.require('goog.ui.Tab');
        goog.require('goog.ui.TabBar');
        goog.require('goog.ui.Textarea');
        goog.require('goog.ui.TextareaRenderer');
        goog.require('goog.ui.SplitPane');
        goog.require('goog.ui.SplitPane.Orientation');
    </script>
</head>
<body>
<div id="header" class="header row">
    <div id="create_function_button"
         class="goog-flat-button goog-inline-block"
         title="Define a new function to use in your program">
        Create a new function
    </div>
    <div id="evaluate_expression_button"
         class="goog-flat-button goog-inline-block"
         title="Evaluate the program in the main workspace">
        Evaluate expression in Main Workspace
    </div>
    <div id="evaluation_results"></div>
</div>
<div class="body row scroll-y">
    <div id="workspace_tabs" class="goog-tab-bar goog-tab-bar-top">
        <div id="tab_blockly_main" class="goog-tab goog-tab-selected">Main Workspace</div>
    </div>
    <div class="goog-tab-bar-clear"></div>
    <div id="workspace_content" class="goog-tab-content">
        <div class="container">
            <iframe id="blockly_main" src="Javascript:''"></iframe>
        </div>
    </div>
</div>
<script>
    var r = Ray.Main.create_ray();
    var blocks = Ray.Main.create_ray_blocks(r);
    Ray.Shared.set_ray_instance(r);
    Ray.Shared.set_blocks(blocks);
    var dialog = Ray.UI.make_function_definition_dialog();
    Ray.UI.populate_dialog_w_test_data(dialog);

    var workspace_content = goog.dom.getElement('workspace_content');
    var tabbar = new goog.ui.TabBar();
    tabbar.decorate(goog.dom.getElement('workspace_tabs'));
    //tabbar.setSelectedTabIndex(0);
    tabbar.getSelectedTab().workspace_id_ = 'blockly_main';

    goog.events.listen(tabbar, goog.ui.Component.EventType.SELECT, function(e) {
        var tab_selected = e.target;
        var content_element = goog.dom.getElement('workspace_content');
    })

    var create_function_button = new goog.ui.Button(undefined, goog.ui.FlatButtonRenderer.getInstance());
    create_function_button.decorate(goog.dom.getElement('create_function_button'));
    goog.events.listen(create_function_button, goog.ui.Component.EventType.ACTION, function(e) {
        dialog.setVisible(true);
    });

    var evaluate_button = new goog.ui.Button(undefined, goog.ui.FlatButtonRenderer.getInstance());
    evaluate_button.decorate(goog.dom.getElement('evaluate_expression_button'));

    var evaluation_results = goog.dom.getElement('evaluation_results');
    goog.style.setInlineBlock(evaluation_results);
    goog.dom.setTextContent(evaluation_results, 'Results of last evaluation...');

    goog.events.listen(evaluate_button, goog.ui.Component.EventType.ACTION, function(e) {
        var result = Ray.Main.go();
        goog.dom.setTextContent(evaluation_results, result);
    });

    goog.events.listen(dialog.getButtonSet().getButton('create'), goog.events.EventType.CLICK, function(e) {
        var func_specs = Ray.UI.get_function_definition_dialog_values(dialog);
        var results = Ray.Main.make_function_application_and_argument_blocks(r, func_specs);
        var func_arg_blocks = results[0];
        var func_use_block = results[1];
        var func_block_name = results[2];
        Ray.Shared.add_to_saved_blocks(func_block_name, func_use_block);

        var func_def_workspace = Ray.UI.add_function_definition_workspace_dom(func_specs.name,
                                                                         workspace_content);
        var func_def_tab = Ray.UI.add_function_definition_workspace_tab(func_specs.name, tabbar);

        Ray.Main.load_func_def_blockly(func_def_workspace,
                                       func_arg_blocks,
                                       func_specs.name,
                                       func_specs,
                                       [func_block_name],
                                       func_specs.return_type);

        tabbar.setSelectedTab(func_def_tab);
        Ray.UI.show_workspace_from_tab(func_def_tab, workspace_content);
    });

    goog.events.listen(tabbar, goog.ui.Component.EventType.SELECT, function(e) {
        console.log('Hello');
        Ray.UI.show_workspace_from_tab(e.target, workspace_content);
    });

    //Ray.Main.initialize_main_blockly_dom();
    Ray.Main.initialize_function_definition_blockly_dom();
    Ray.Main.load_main_blockly(Ray.Main.main_blockly());
</script>
</body>

</html>